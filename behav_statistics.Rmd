---
title: "behav_statistics"
author: "XinHao"
date: "2025-11-07"
output: html_document
---

```{r stats}
# ----------------- 0. 加载包 -----------------
pkg_list <- c("ggplot2", "readxl", "tidyr", "dplyr", "ggprism", 
              "patchwork", "stringr", "lme4", "emmeans", "bruceR")
sapply(pkg_list, function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg)
  library(pkg, character.only = TRUE)})

# ----------------- 1. 参数定义 -----------------
file_path <- "C:/Users/XinHao/Desktop/tES_SZ_Behav/behavior_data.xlsx"
output_dir <- "C:/Users/XinHao/Desktop/tES_SZ_Behav/"
sheets <- c("IC", "WS", "RD", "TV")

# ----------------- 2. 自定义主题 -----------------
theme_custom <- theme_prism(axis_text_angle = 0) +
  theme(panel.grid = element_blank(),
    axis.line = element_line(color = 'black', size = 0.75),
    axis.ticks = element_line(color = 'black', size = 0.75),
    axis.text = element_text(size = 10, color = "black"),
    axis.title = element_text(size = 12),
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    legend.position = "right")

# ----------------- 3. 遍历每个 sheet -----------------
for (sheet in sheets) {
  df_wide_raw <- read_excel(file_path, sheet = sheet)
  
  # ----- 在一开始就对 Group 做盲法重编码并设为 factor（确保模型 & 图一致） -----
  df_wide <- df_wide_raw %>%
    mutate(Group = as.character(Group),
      Group = recode(Group,"1" = "7", "2" = "9", "3" = "8", "4" = "6", "5" = "10"),
      Group = factor(Group, levels = c("6", "7", "8", "9", "10")))

  # ----------------- 4. MANOVA分析 -----------------
  # ---- 模型 A：只用 Block 1 和 Block 5 ----
  df_A_wide <- df_wide %>% select(ID, Group, paste0("B1C", 1:3), paste0("B5C", 1:3))
  Model_A <- MANOVA(df_A_wide, dvs = c("B1C1", "B1C2", "B1C3", "B5C1", "B5C2", "B5C3"),
                    dvs.pattern = "B(.)C(.)", within = c('Block', 'Condition'),
                    between = 'Group', sph.correction = "GG",
                    aov.include = FALSE, digits = 3) %>%
    EMMEANS(effect = c("Group", "Block"), by = "Condition",
            contrast = "pairwise", p.adjust = "fdr", model.type = "multivariate")
  
  # ---- 模型 B：Block 1 到 Block 4 ----
  df_B_wide <- df_wide %>% select(ID, Group, unlist(lapply(1:4, function(b) paste0("B", b, "C", 1:3))))
  Model_B <- MANOVA(df_B_wide, dvs = "B1C1:B4C3", dvs.pattern = "B(.)C(.)",
                    within = c('Block', 'Condition'), between = 'Group',
                    sph.correction = "GG", aov.include = FALSE, digits = 3) %>%
    EMMEANS(effect = c("Group", "Block"), by = "Condition",
            contrast = "pairwise", p.adjust = "fdr", model.type = "multivariate")
  
  # 转为长格式
  df_long <- df_wide %>%
    pivot_longer(cols = starts_with("B"), names_to = "BlockCond", values_to = "Y") %>%
    mutate(Block = as.integer(str_extract(BlockCond, "(?<=B)\\d")),
      Condition_code = str_extract(BlockCond, "(?<=C)\\d"),
      Condition = recode(Condition_code,"1" = "HA","2" = "HB","3" = "HEO"),
      Session = ifelse(Block <= 4, "Pre", "Post"),
      Subject = as.factor(ID),
      Condition = factor(Condition, levels = c("HA", "HB", "HEO")),
      Session = factor(Session, levels = c("Pre", "Post"))) %>%
    dplyr::select(Subject, Group, Session, Block, Condition, Y)

  # 创建每个 Condition 下的两张图（共 6 图）
  df_A_long_subset <- df_long %>% filter((Session == "Pre" & Block == 1) | Session == "Post")
  df_B_long_subset <- df_long %>% filter(Session == "Pre")
  plot_list <- list()
  for (cond in levels(df_long$Condition)) {
    
    # ------- 图1：Block × Group（带散点 + 黑边框填充与柱一致 + 被试连线） -------
    df_B_cond <- df_B_long_subset %>%
      filter(Condition == cond) %>%
      mutate(Block = factor(Block, levels = 1:4,
                            labels = c("Baseline", "Online1", "Online2", "Offline")))
    
    dodge_width <- 0.8
    # 自动为 n blocks 生成对称偏移，使点与 position_dodge 对齐
    n_blocks <- length(levels(df_B_cond$Block))
    # 计算每个 block 在 dodge 宽度内的中心位置（避开两端的 1/(2n) 间隙）
    offsets_seq <- seq(from = -dodge_width/2 + dodge_width/(2*n_blocks),
                       to   =  dodge_width/2 - dodge_width/(2*n_blocks),
                       length.out = n_blocks)
    # 构造命名向量，便于索引
    offsets <- setNames(offsets_seq, levels(df_B_cond$Block))
    
    # 计算真实横坐标：Group -> 序号 + 对应 block 的偏移
    df_B_cond <- df_B_cond %>%
      mutate(Group_num = as.numeric(as.factor(Group)),
             x_pos = Group_num + offsets[as.character(Block)])
    
    p_B <- ggplot() +
      stat_summary(data = df_B_cond,
                   aes(x = Group, y = Y, fill = Block),
                   fun = mean, geom = "bar",
                   position = position_dodge(width = dodge_width),
                   width = 0.7, colour = NA, size = 0.5) +
      # stat_summary(data = df_B_cond, aes(x = Group, y = Y, group = Block),
      #    fun.data = mean_se, geom = "errorbar",
      #    position = position_dodge(width = dodge_width), width = 0.2, size = 0.5) +
      geom_line(data = df_B_cond, aes(x = x_pos, y = Y, group = Subject),
                colour = "grey60", linewidth = 0.35, alpha = 0.6) +
      geom_point(data = df_B_cond, aes(x = x_pos, y = Y, fill = Block),
                 shape = 21, size = 2.6, stroke = 0.45,
                 colour = "black", alpha = 0.95, show.legend = FALSE) +
      scale_fill_brewer(palette = "Pastel2") +
      labs(x = "Group", y = sheet, fill = "Block", title = paste0(cond, " - Block")) +
      theme_custom
    
    # ------- 图2：Session × Group（带散点与被试连线） -------
    df_A_cond <- df_A_long_subset %>% filter(Condition == cond) %>%
          mutate(Block_label = ifelse(Session == "Pre", "Pre-test", "Post-test"),
          Block_label = factor(Block_label, levels = c("Pre-test", "Post-test")))

    # 计算 x 真实位置：把 Group 转为数值并加上横向偏移以对齐 dodge 后的点
    dodge_width <- 0.8
    # 经验偏移：二元分组常用 ±0.20；如需微调可改为 0.18/0.22
    offset_val <- 0.20
    offsets <- c("Pre-test" = -offset_val, "Post-test" = offset_val)

    df_A_cond <- df_A_cond %>%
      mutate(Group_num = as.numeric(as.factor(Group)),   # 确保 Group_num 是整数
             x_pos = Group_num + offsets[as.character(Block_label)])
    p_A <- ggplot() +
      stat_summary(data = df_A_cond, aes(x = Group, y = Y, fill = Block_label),
                   fun = mean, geom = "bar", position = position_dodge(width = dodge_width),
                   width = 0.7, colour = NA, size = 0.5) +
      # stat_summary(fun.data = mean_se, geom = "errorbar",
      #              position = position_dodge(width = 0.8), width = 0.5, size = 0.5) +
      geom_line(data = df_A_cond, aes(x = x_pos, y = Y, group = Subject),
                colour = "grey60", linewidth = 0.4, alpha = 0.6) +
      geom_point(data = df_A_cond, aes(x = x_pos, y = Y, colour = Block_label),
                 shape = 21, size = 2.2, stroke = 0.4, colour = "black", 
                 alpha = 1, show.legend = FALSE) +
      scale_fill_brewer(palette = "Pastel1") +
      # scale_colour_brewer(palette = "Pastel1") + #控制散点边框颜色
      labs(x = "Group", y = sheet, fill = "Session", title = paste0(cond, " - Session")) +
      theme_custom
    
    plot_list[[paste0(cond, "_Block")]] <- p_B
    plot_list[[paste0(cond, "_Session")]] <- p_A
  }
  # 组合成 2行 × 3列
  plot_list <- plot_list[c(1, 3, 5, 2, 4, 6)]
  combined_plot <- wrap_plots(plot_list, ncol = 3)
  print(combined_plot)
  # 保存图像
  ggsave(filename = paste0(output_dir, "Plot_", sheet, ".png"),
         plot = combined_plot, width = 16, height = 10, dpi = 300)
}

```

```{r diff}
plot_list_diff <- list()
for (sheet in sheets) {
  df_wide_raw <- read_excel(file_path, sheet = sheet)
  
  df_wide_raw <- df_wide_raw %>%
  mutate(Group = as.character(Group),
      Group = recode(Group,"1" = "7", "2" = "9", "3" = "8", "4" = "6", "5" = "10"),
      Group = factor(Group, levels = c("6", "7", "8", "9", "10")))
  df_eff <- df_wide_raw %>%
  mutate(Subject = as.factor(ID),
    Diff1  = B5C1 - B1C1, Diff2  = B5C2 - B1C2, Diff3 = B5C3 - B1C3, Group = factor(Group))
  Model_Diff <- MANOVA(df_eff, dvs = "Diff1:Diff3", dvs.pattern = "Diff(.)",
                    within = 'Condition', between = 'Group', sph.correction = "GG",
                    aov.include = FALSE, digits = 3) %>%
  EMMEANS(effect = "Group", by = "Condition",
          contrast = "pairwise", p.adjust = "fdr", model.type = "multivariate")
  
  df_eff_long <- df_eff %>%
  select(Subject, Group, Diff1, Diff2, Diff3) %>%
  pivot_longer(cols = starts_with("Diff"), names_to = "Condition",
               names_prefix = "Diff", values_to = "Effect") %>%
  mutate(Condition = recode(Condition, "1" = "HA", "2" = "HB", "3" = "HEO"),
    Condition = factor(Condition, levels = c("HA", "HB", "HEO")), Group = as.factor(Group))

  # ------- effect 图：
  # 假设 df_eff_long 已包含 Subject, Group, Condition (factor levels: HA, HB, HEO), Effect
  dodge_width <- 0.8
  # 自动为 n conditions 生成对称偏移（用于计算 x_pos）
  n_cond <- length(levels(df_eff_long$Condition))
  offsets_seq <- seq(from = -dodge_width/2 + dodge_width/(2*n_cond),
                     to   =  dodge_width/2 - dodge_width/(2*n_cond),
                     length.out = n_cond)
  offsets <- setNames(offsets_seq, levels(df_eff_long$Condition))
  
  # 计算真实横坐标 x_pos（用于点与线）
  df_eff_plot <- df_eff_long %>%
    mutate(Group_num = as.numeric(as.factor(Group)),
           x_pos = Group_num + offsets[as.character(Condition)])
  
  p_effect <- ggplot() +
    stat_summary(data = df_eff_plot, aes(x = Group, y = Effect, fill = Condition),
                 fun = mean, geom = "bar",
                 position = position_dodge(width = dodge_width),
                 width = 0.7, colour = NA, size = 0.5) +
    # stat_summary(data = df_eff_plot, aes(x = Group, y = Effect, group = Condition),
    #              fun.data = mean_se, geom = "errorbar",
    #              position = position_dodge(width = dodge_width), width = 0.25, size = 0.5) +
    geom_line(data = df_eff_plot, aes(x = x_pos, y = Effect, group = Subject),
              colour = "grey60", linewidth = 0.35, alpha = 0.6) +
    geom_point(data = df_eff_plot, aes(x = x_pos, y = Effect, fill = Condition),
               shape = 21, size = 2.6, stroke = 0.45,
               colour = "black", alpha = 0.95, show.legend = FALSE) +
    scale_fill_brewer(palette = "Pastel2") +
    labs(x = "Group", y = paste0(sheet, " effect"), fill = "Condition",
         title = paste0(sheet, " effect")) +
    theme_custom
  plot_list_diff[[sheet]] <- p_effect
}
combined_plot_all <- wrap_plots(plot_list_diff, ncol = 2, nrow = 2) 
print(combined_plot_all)
ggsave(filename = paste0(output_dir, "Plots_effect.png"),
       plot = combined_plot_all, width = 16, height = 12, dpi = 600)
```
